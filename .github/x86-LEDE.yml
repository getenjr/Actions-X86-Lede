#
# Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# https://github.com/P3TERX/Actions-OpenWrt
# Description: Build OpenWrt using GitHub Actions
#

name: Build x86 Lede

on:
  schedule:
    - cron: 0 20 * * 0
  repository_dispatch:
  workflow_dispatch:
    inputs:
      firewall:
        description: 'WANå£å¯ç”¨é˜²ç«å¢™'
        required: false
        default: 'true'
        type: choice
        options:
          - 'false'
          - 'true'
      lan-ip:
        description: 'LANå£IP'
        required: false
        default: ''
      wan-ip:
        description: 'WANå£IP'
        required: false
        default: ''
      wan-netmask:
        description: 'WANå£æŽ©ç '
        required: false
        default: ''
      wan-gateway:
        description: 'WANå£ç½‘å…³'
        required: false
        default: ''
      npc-protocol:
        description: 'NPSæœåŠ¡ç«¯é€šä¿¡åè®®'
        required: false
        default: 'tcp'
        type: choice
        options:
          - 'tcp'
          - 'kcp'
      npc-server:
        description: 'NPSæœåŠ¡ç«¯åœ°å€'
        required: false
        default: ''
      npc-port:
        description: 'NPSæœåŠ¡ç«¯ç«¯å£'
        required: false
        default: ''
      npc-vkey:
        description: 'NPSæœåŠ¡ç«¯å¯†é’¥'
        required: false
        default: ''
env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  RELEASE_PREFIX: lede
  FEEDS_CONF: feeds.conf
  CONFIG_FILE: x86.config
  DIY_P1_SH: x86-part1.sh
  DIY_P2_SH: x86-part2.sh
  DISTFEEDS: distfeeds.conf
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: åˆå§‹åŒ–å·¥ä½œçŽ¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt -qq update -y
          sudo -E apt -qq full-upgrade -y
          sudo -E apt -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          sudo -E apt -qq autoremove --purge
          sudo -E apt -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: å…‹éš† Lede æºç 
        working-directory: /workdir
        run: |
          df -hT $PWD
          git clone $REPO_URL -b $REPO_BRANCH lede
          ln -sf /workdir/lede $GITHUB_WORKSPACE/lede

      - name: è½½å…¥è‡ªå®šä¹‰ Feeds
        run: |
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF lede/feeds.conf.default
          chmod +x $DIY_P1_SH
          cd lede
          $GITHUB_WORKSPACE/$DIY_P1_SH

      - name: æ›´æ–° Feeds
        run: cd lede && ./scripts/feeds update -a

      - name: å®‰è£… Feeds
        run: cd lede && ./scripts/feeds install -a

      - name: è½½å…¥è‡ªå®šä¹‰é…ç½®
        run: |
          [ -e files ] && mv files lede/files
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE lede/.config

      - name: è®¾ç½®åˆæ¬¡å¯åŠ¨è„šæœ¬å¯æ‰§è¡Œæƒé™
        run: |
          [ -e lede/files/etc/uci-defaults ] && chmod +x -R lede/files/etc/uci-defaults/
          [ -e lede/files/etc/uci-defaults ] && ls -l lede/files/etc/uci-defaults/

      - name: è¿è¡Œè‡ªå®šä¹‰è„šæœ¬
        env:
          ENABLE_FIREWALL: ${{github.event.inputs.firewall}}
          LAN_IP: ${{github.event.inputs.lan-ip}}
          WAN_IP: ${{github.event.inputs.wan-ip}}
          WAN_NETMASK: ${{github.event.inputs.wan-netmask}}
          WAN_GATEWAY: ${{github.event.inputs.wan-gateway}}
          NPC_PROTOCOL: ${{github.event.inputs.npc-protocol}}
          NPC_SERVER: ${{github.event.inputs.npc-server}}
          NPC_PORT: ${{github.event.inputs.npc-port}}
          NPC_VKEY: ${{github.event.inputs.npc-vkey}}
        run: |
          chmod +x $DIY_P2_SH
          cd lede
          $GITHUB_WORKSPACE/$DIY_P2_SH

      - name: ä¸‹è½½æ‰€éœ€æ–‡ä»¶
        id: package
        run: |
          cd lede
          make defconfig
          make download -j$(nproc)

      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd lede
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
          [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: æ£€æŸ¥ä½¿ç”¨ç©ºé—´
        if: (!cancelled())
        run: df -hT

      - name: ä¸Šä¼  Bin ç›®å½•
        uses: actions/upload-artifact@main
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
        with:
          name: Lede_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: lede/bin

      - name: æ¸…ç†å¤šä½™æ–‡ä»¶
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          cd lede/bin/targets/*/*
          rm -rf packages
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ å›ºä»¶ç›®å½•
        uses: actions/upload-artifact@main
        if: steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: Lede_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}

      - name: ä¸Šä¼ å›ºä»¶åˆ° cowtransfer
        id: cowtransfer
        if: steps.organize.outputs.status == 'success' && env.UPLOAD_COWTRANSFER == 'true' && !cancelled()
        run: |
          curl -fsSL git.io/file-transfer | sh
          ./transfer cow --block 2621440 -s -p 64 --no-progress ${FIRMWARE} 2>&1 | tee cowtransfer.log
          echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
          echo "url=$(cat cowtransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ å›ºä»¶åˆ° WeTransfer
        id: wetransfer
        if: steps.organize.outputs.status == 'success' && env.UPLOAD_WETRANSFER == 'true' && !cancelled()
        run: |
          curl -fsSL git.io/file-transfer | sh
          ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
          echo "::warning file=wetransfer.com::$(cat wetransfer.log | grep https)"
          echo "url=$(cat wetransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆ Release æ ‡ç­¾
        id: tag
        if: steps.organize.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
        env:
          ENABLE_FIREWALL: ${{github.event.inputs.firewall}}
          LAN_IP: ${{github.event.inputs.lan-ip}}
          WAN_IP: ${{github.event.inputs.wan-ip}}
          WAN_NETMASK: ${{github.event.inputs.wan-netmask}}
          WAN_GATEWAY: ${{github.event.inputs.wan-gateway}}
          NPC_PROTOCOL: ${{github.event.inputs.npc-protocol}}
          NPC_SERVER: ${{github.event.inputs.npc-server}}
          NPC_PORT: ${{github.event.inputs.npc-port}}
          NPC_VKEY: ${{github.event.inputs.npc-vkey}}
        run: |
          LAN_PREFIX=""
          if [[ "${LAN_IP}" != "" ]]; then
            LAN_PREFIX="-"
          fi
          FIREWALL_TEXT=""
          if [[ "${ENABLE_FIREWALL}" == "true" ]]; then
            FIREWALL_TEXT="-firewall"
          fi
          CUSTOMIZE_TEXT=""
          if [[ "${WAN_IP}" != "" && "${WAN_NETMASK}" != "" && "${WAN_GATEWAY}" != "" ]] || [[ "${NPC_SERVER}" != "" && "${NPC_PORT}" != "" && "${NPC_VKEY}" != "" ]]; then
            CUSTOMIZE_TEXT="-customize"
          fi
          echo "release_tag=${RELEASE_PREFIX}${LAN_PREFIX}${LAN_IP}${FIREWALL_TEXT}${CUSTOMIZE_TEXT}-$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
          touch release.txt
          [ $UPLOAD_COWTRANSFER = true ] && echo "ðŸ”— [Cowtransfer](${{ steps.cowtransfer.outputs.url }})" >> release.txt
          [ $UPLOAD_WETRANSFER = true ] && echo "ðŸ”— [WeTransfer](${{ steps.wetransfer.outputs.url }})" >> release.txt
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ å›ºä»¶åˆ° Release
        uses: softprops/action-gh-release@v1
        if: steps.tag.outputs.status == 'success' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: ${{ env.FIRMWARE }}/*

      - name: åˆ é™¤ workflow runs
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 3
          keep_minimum_runs: 3

      - name: åˆ é™¤æ—§çš„ Releases
        uses: dev-drprasad/delete-older-releases@master
        if: steps.organize.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
        with:
          keep_latest: 9
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
